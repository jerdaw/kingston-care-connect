name: Monthly Health Check

on:
  schedule:
    - cron: "0 8 1 * *" # 8 AM UTC on the 1st of each month
  workflow_dispatch:

jobs:
  url-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - run: npm ci

      - name: Run URL Health Check
        id: health-check
        run: npm run health-check
        continue-on-error: true

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: url-health-report
          path: data/url-health-report.json

      - name: Create Issue on Failure
        if: steps.health-check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const reportPath = 'data/url-health-report.json';

            if (!fs.existsSync(reportPath)) {
              console.log('No health report found. Skipping issue creation.');
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));

            if (!report.broken || report.broken.length === 0) {
              console.log('No broken links found. Skipping issue creation.');
              return;
            }

            const brokenList = report.broken
              .map(b => `- [ ] **${b.serviceName}** (ID: \`${b.serviceId}\`)\n  - URL: ${b.url}\n  - Error: ${b.errorMessage || `HTTP ${b.status}`}`)
              .join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”— Monthly Health Check: ${report.broken.length} Broken URLs Found`,
              body: `## URL Health Check Report\n\n**Generated**: ${report.generated}\n\n### Summary\n- âœ… Healthy: ${report.summary.healthy}\n- ğŸ”€ Redirects: ${report.summary.redirects}\n- âŒ Broken: ${report.summary.broken}\n\n### Broken URLs\n\n${brokenList}\n\n---\n*This issue was automatically generated by the monthly health check workflow.*`,
              labels: ['data-quality', 'automated']
            });
