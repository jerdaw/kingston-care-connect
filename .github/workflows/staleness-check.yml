name: Monthly Staleness Check

on:
  schedule:
    # Run at 9am ET on the 1st of each month
    - cron: "0 14 1 * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  check-staleness:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run staleness check
        id: staleness
        run: npx tsx scripts/check-staleness.ts

      - name: Create issue if stale services found
        if: steps.staleness.outputs.stale_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const staleIds = '${{ steps.staleness.outputs.stale_ids }}'.split(',');
            const staleCount = parseInt('${{ steps.staleness.outputs.stale_count }}');
            
            const body = `## ðŸ”´ Stale Services Detected
            
            **${staleCount} service(s)** have not been verified in over 6 months.
            
            Per the [Governance Protocol](docs/governance.md), services not verified in >6 months should be downgraded to L0 (hidden).
            
            ### Services Requiring Attention
            
            ${staleIds.map(id => `- [ ] \`${id}\``).join('\n')}
            
            ### Actions Required
            
            For each service above:
            1. Verify the service is still operating (call phone, check website)
            2. Update \`provenance.verified_at\` in \`data/services.json\`
            3. OR downgrade \`verification_level\` to "L0" if no longer valid
            
            ### Verification Checklist
            
            - [ ] Phone number connects
            - [ ] Website loads
            - [ ] Hours are current
            - [ ] Address is correct
            - [ ] French translation is current
            
            ---
            *This issue was automatically created by the staleness check workflow.*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”´ Monthly Staleness Check: ${staleCount} stale service(s) found`,
              body: body,
              labels: ['data-quality', 'governance']
            });
